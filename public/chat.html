<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chat | NETAME</title>
    <link rel="stylesheet" href="/style.css">
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&family=Space+Grotesk:wght@300;400;700&display=swap"
        rel="stylesheet">
    <style>
        .chat-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 0;
            overflow: hidden;
        }

        .chat-area {
            flex-grow: 1;
            overflow-y: auto;
            padding: 2rem 5%;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            scroll-behavior: smooth;
        }

        .message {
            max-width: 80%;
            padding: 1.5rem;
            border-radius: 20px;
            font-size: 1.1rem;
            line-height: 1.6;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.ai {
            align-self: flex-start;
            background: rgba(255, 255, 255, 0.05);
            border-bottom-left-radius: 5px;
            border: 1px solid var(--border-color);
        }

        .message.user {
            align-self: flex-end;
            background: rgba(255, 255, 255, 0.15);
            border-bottom-right-radius: 5px;
            color: white;
        }

        .chat-input-area {
            padding: 2rem 5%;
            background: rgba(10, 10, 10, 0.8);
            backdrop-filter: blur(20px);
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .chat-input {
            flex-grow: 1;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            padding: 1.2rem;
            border-radius: 12px;
            color: white;
            font-size: 1rem;
            font-family: 'Outfit', sans-serif;
            outline: none;
            transition: var(--transition-smooth);
        }

        .chat-input:focus {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.3);
        }

        .send-btn {
            background: white;
            color: black;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition-smooth);
        }

        .send-btn:hover {
            transform: scale(1.05);
        }

        .typing-dots {
            font-style: italic;
            opacity: 0.7;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% {
                opacity: 0.4;
            }

            50% {
                opacity: 1;
            }

            100% {
                opacity: 0.4;
            }
        }
    </style>
    <link rel="stylesheet" href="chat_enhancements.css">
</head>

<body>
    <div class="crystal-overlay"></div>

    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <a href="index.html" style="text-decoration: none;"><span class="logo-text">NETAME</span></a>
            <button id="sidebar-toggle" class="sidebar-toggle">
                <svg viewBox="0 0 24 24" width="20" height="20" stroke="currentColor" stroke-width="2" fill="none">
                    <polyline points="15 18 9 12 15 6"></polyline>
                </svg>
            </button>
        </div>
        <nav class="sidebar-links">
            <a href="index.html" class="sidebar-link">
                <svg viewBox="0 0 24 24" width="20" height="20" stroke="currentColor" stroke-width="2" fill="none">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                    <polyline points="9 22 9 12 15 12 15 22"></polyline>
                </svg>
                <span>Home</span>
            </a>
            <a href="schedule.html" class="sidebar-link">
                <svg viewBox="0 0 24 24" width="20" height="20" stroke="currentColor" stroke-width="2" fill="none">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                    <line x1="16" y1="2" x2="16" y2="6"></line>
                    <line x1="8" y1="2" x2="8" y2="6"></line>
                    <line x1="3" y1="10" x2="21" y2="10"></line>
                </svg>
                <span>Schedule</span>
            </a>
            <a href="movies.html" class="sidebar-link">
                <svg viewBox="0 0 24 24" width="20" height="20" stroke="currentColor" stroke-width="2" fill="none">
                    <rect x="2" y="2" width="20" height="20" rx="2.18" ry="2.18"></rect>
                    <line x1="7" y1="2" x2="7" y2="22"></line>
                    <line x1="17" y1="2" x2="17" y2="22"></line>
                    <line x1="2" y1="12" x2="22" y2="12"></line>
                </svg>
                <span>Movies</span>
            </a>
            <a href="tv.html" class="sidebar-link">
                <svg viewBox="0 0 24 24" width="20" height="20" stroke="currentColor" stroke-width="2" fill="none">
                    <rect x="2" y="7" width="20" height="15" rx="2" ry="2"></rect>
                    <polyline points="17 2 12 7 7 2"></polyline>
                </svg>
                <span>TV Series</span>
            </a>
            <a href="wisewords.html" class="sidebar-link">
                <svg viewBox="0 0 24 24" width="20" height="20" stroke="currentColor" stroke-width="2" fill="none">
                    <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path>
                    <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path>
                </svg>
                <span>Wise Words</span>
            </a>
            <a href="chat.html" class="sidebar-link active">
                <svg viewBox="0 0 24 24" width="20" height="20" stroke="currentColor" stroke-width="2" fill="none">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                </svg>
                <span>AI Assistant</span>
            </a>
        </nav>

        <div class="sidebar-search">
            <svg viewBox="0 0 24 24" width="18" height="18" stroke="currentColor" stroke-width="2" fill="none">
                <circle cx="11" cy="11" r="8"></circle>
                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
            </svg>
            <input type="text" id="anime-search" placeholder="Search...">
        </div>
    </aside>

    <main class="chat-container">
        <div class="chat-area" id="chat-feed">
            <div class="message ai">
                Hello! I'm your NETAME AI assistant. How can I help you explore the anime world today?
            </div>
        </div>
        <div class="chat-input-area">
            <input type="text" class="chat-input" id="user-input"
                placeholder="Ask for recommendations, summaries, or anime facts...">
            <button class="send-btn" id="send-msg">
                <svg viewBox="0 0 24 24" width="20" height="20" stroke="currentColor" stroke-width="2" fill="none">
                    <line x1="22" y1="2" x2="11" y2="13"></line>
                    <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                </svg>
            </button>
        </div>
    </main>

    <script src="/app.js"></script>
    <script>
        // Groq Configuration
        // Requests are proxied through our backend to keep the API key safe
const API_URL = '/api/ai';
                const MODEL = 'llama-3.1-8b-instant';

        const input = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-msg');
        const feed = document.getElementById('chat-feed');

        // Chat History context
        let history = [
            { role: "system", content: "You are NETAME AI, a helpful and knowledgeable anime assistant. You help users find anime, explain plots, and give personalized recommendations. You also know inspiring quotes from anime known as 'Wise Words'. \n\nIMPORTANT FORMAT RULES:\n• When you recommend ANY anime title you MUST embed its AniList numeric ID in the text exactly as [anime:ID]. For example: Hunter x Hunter (2011) [anime:11061].\n• You may recommend up to 3 titles per request.\n• If the user asks for a wise quote, return the quote followed by \"— Character, Anime\".\nKeep answers concise and friendly." }
        ];

        async function send() {
            const txt = input.value.trim();
            if (!txt) return;

            // Add user msg to UI
            addMessage('user', txt);

            // Add to history
            history.push({ role: "user", content: txt });

            input.value = '';
            input.disabled = true;
            sendBtn.disabled = true;

            // Loading indicator
            const loadingId = addMessage('ai', '<span class="typing-dots">Thinking...</span>');

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                                                'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: MODEL,
                        messages: history
                    })
                });

                if (!response.ok) throw new Error(`API Error: ${response.status}`);

                const data = await response.json();
                const reply = data.choices[0].message.content;
                const animeMatches = [...reply.matchAll(/\[[^\]:]*:(\d+)\]/g)];
                const cleanReply = reply.replace(/\[[^\]:]+:\d+\]/g, '').trim();

                // Remove loading indicator
                document.getElementById(loadingId).remove();
                const newId = addMessage('ai', '');
                typeWriter(newId, cleanReply);

                // Render anime cards
                animeMatches.forEach(match => {
                    const animeId = match[1];
                    fetchAndRenderAnime(animeId);
                });

                // Update history
                history.push({ role: "assistant", content: reply });

            } catch (error) {
                console.error(error);
                document.getElementById(loadingId).remove();
                addMessage('ai', 'Sorry, I encountered an error connecting to the neural network. Please try again.');
            } finally {
                input.disabled = false;
                sendBtn.disabled = false;
                input.focus();
            }
        }

        function addMessage(role, htmlContent) {
            const id = 'msg-' + Date.now();
            const div = document.createElement('div');
            div.className = `message ${role}`;
            div.id = id;
            div.innerHTML = htmlContent;
            feed.appendChild(div);
            feed.scrollTop = feed.scrollHeight;
            return id;
        }

        // Typewriter animation for AI assistant replies
        function markdownToHtml(str) {
            return str
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/__(.*?)__/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/_(.*?)_/g, '<em>$1</em>')
                .replace(/\[(.*?)\]\((.*?)\)/g, '<a href="$2" target="_blank">$1<\/a>');
        }

        function typeWriter(id, text, speed = 20) {
            const el = document.getElementById(id);
            if (!el) return;
            const formatted = text.replace(/\n/g, '<br>');
            let idx = 0;
            (function type() {
                if (idx <= formatted.length) {
                    el.innerHTML = formatted.slice(0, idx);
                    feed.scrollTop = feed.scrollHeight;
                    idx++;
                    if (idx <= formatted.length) setTimeout(type, speed);
                    else {
                        // After animation complete convert to HTML markdown
                        el.innerHTML = markdownToHtml(formatted);
                    }
                }
            })();
        }

        // Fetch anime details from AniList
        async function fetchAniListInfo(id) {
            const query = `
                query ($id: Int) {
                    Media(id: $id) {
                        id
                        title { romaji english }
                        coverImage { large extraLarge }
                        averageScore
                        format
                    }
                }
            `;
            try {
                const res = await fetch('https://graphql.anilist.co', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                    body: JSON.stringify({ query, variables: { id: parseInt(id) } })
                });
                const json = await res.json();
                return json.data.Media;
            } catch {
                return null;
            }
        }

        function renderAnimeCard(anime) {
            if (!anime) return;
            const card = document.createElement('div');
            card.className = 'chat-anime-card';
            card.innerHTML = `
                <img class="chat-anime-poster" src="${anime.coverImage.large || anime.coverImage.extraLarge}" alt="${anime.title.english || anime.title.romaji}">
                <div class="chat-anime-info">
                    <div class="chat-anime-title">${anime.title.english || anime.title.romaji}</div>
                    <div class="chat-anime-meta">${anime.format} • ${anime.averageScore ? anime.averageScore + '%' : 'N/A'}</div>
                </div>`;
            card.onclick = () => window.location.href = `info.html?id=${anime.id}`;
            feed.appendChild(card);
            feed.scrollTop = feed.scrollHeight;
        }

        async function fetchAndRenderAnime(id) {
            const anime = await fetchAniListInfo(id);
            renderAnimeCard(anime);
        }

        sendBtn.addEventListener('click', send);
        input.addEventListener('keypress', (e) => { if (e.key === 'Enter') send() });
    </script>
</body>

</html>